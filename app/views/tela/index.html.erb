<audio src="" id="tts" hidden></audio>

<script type="text/javascript">
  // https://notificationsounds.com/notification-sounds/definite-555
  var audioNotificacao = new Audio('/definite.mp3')
</script>

<div class="header" id="descricao">
  
</div>

<div class="content">
    <div class="left Aligner">
      <div class="Aligner-item">
        <div style="display: none; font-size: xx-large;">Sua vez,<br><b><span id="nome"></span></b></div>
        <div style="font-size: xx-large;" id="mesas"></div>
      </div>
    </div>
    
    <div id="proximos" class="right">
      <div class="row"><h1 style="padding-left: 3px;">Próximos da fila</h1></div>
      <div class="row"></div>
      <div class="row"></div>
      <div class="row"></div>
      <div class="row"></div>
      <div class="row"></div>
      
    </div>
  </div>
        
</div>

<div class="footer Aligner">
  <div class="Aligner-item">
    <% if user_signed_in? %>
      <table>
        <tr>
          <td style="font-size: large;">Para entrar na fila, digite sua <b>matrícula</b> e pressione Enter:</td>
          <td><input type="text" name="matricula" id="matricula" autofocus style="font-size: xx-large; font-weight: bold;"></td>
        </tr>
      </table>
        
      
      
      
      <!-- <button id="btnMatricula">Inscrever</button> -->
    <% else %>
      &nbsp;
    <% end %>
  </div>
</div>

<div id="dialog-confirma" title="Nome adicionado">
  <p>Olá, <b><span class="nome"></span></b>, agora você está na posição <b><span class="posicao"></span></b> da fila.</p>
  <p>Pressione <b>Enter</b> para fechar.</p>
</div>

<div id="dialog-erro" title="Você NÃO foi adicionado">
  <!-- <p>Você <b>não</b> foi adicionado(a) à fila.</p> -->
  <!-- <p>Número digitado: <b><span class="matricula"></span></b></p> -->

  <p style="color: darkred; font-weight: bold;"><span class="mensagem"></span></p>

  <p>Pressione <b>Enter</b> para fechar.</p>
</div>


<script>
  $( function() {
    var options = {
      draggable: false,
      modal: true,
      autoOpen: false,
      width: '60%'
    };
    $("#dialog-confirma").dialog(options);
    $("#dialog-confirma").on('dialogclose', function (event) {
      window.location.reload(true); 
    });
    $("#dialog-erro").dialog(options);
  } );
</script>

<script type="text/javascript">
  function insereMatricula() {
    var matricula = $("#matricula").val();
    $.post("<%= tela_inscrever_path %>", { matricula: matricula })
      .done(function (data) {
        $("#dialog-confirma .nome").text(data.aluno.nome);
        $("#dialog-confirma .posicao").text(data.posicao);
        $("#dialog-confirma").dialog("open");
       })
      .fail(function (xhr) {
        var data = xhr.responseJSON;
        $("#dialog-erro .mensagem").text('Erro de sistema.');
        if (data) {
          $("#dialog-erro .mensagem").text(data.mensagem);
        }
        $("#dialog-erro .matricula").text(matricula);
        $("#dialog-erro").dialog("open");
      })
      .always(function () { $("#matricula").val(''); });
  }
  $("#btnMatricula").click(insereMatricula);
  $("#matricula").keypress(function (e) {
    if (e.which == 13 || e.keyCode == 13) {
        insereMatricula();
        return false;
    }
    return true;
  });
</script>


<script type="text/javascript">

function blink() {
  var i, interval = 400, times = 6;

  $("#nome").stop(true, true);

  $("#nome").addClass("highlight");
  for (i = 0; i < times; i++) {
    $("#nome").fadeOut(interval);
    $("#nome").fadeIn(interval);
  }
  setTimeout(function () { $("#nome").removeClass("highlight"); }, times * interval * 2);
}

function falaNome(nome) {
  // https://www.youtube.com/watch?v=DOtkNxmg9QY
  // Não está funcionando.
  var text = encodeURIComponent(nome);
  var url = "http://translate.google.com/translate_tts?tl=pt-BR&q=" + text + "&client=tw-ob";
  console.log("URL", url);
  $("#tts").attr("src", url).get(0).play();
}

function atualizaPagina(data) {
  $("#descricao").text(data.rodada.descricao);
  if (data.rodada && data.rodada.aluno_atual) {
    $("#nome").text(data.rodada.aluno_atual.nome);
  }

  s = ""
  for (var i = 0; i < data.mesas.length; i++) {
    s += "<p>";
    s += data.mesas[i].nome + " ";
    s += data.mesas[i].aluno.nome + " ";
    s += "</p>";
  }
  $("#mesas").html(s);

  $("#proximos .row").each(function (idx, elem) {
    if (idx > 0) { // skip first row
      if (data.proximos.length > 0) {
        $(elem).text(data.proximos.shift().aluno.nome);
      } else {
        $(elem).text('');
      }
    }
  });

  // blink();
  audioNotificacao.play();
}

function carregaDados() {
  $.get("<%= tela_dados_path %>")
    .done(atualizaPagina)
    .fail(function () {
      alert("Erro ao tentar obter dados.");
    });
}

document.addEventListener("turbolinks:load", function () {

  carregaDados();
  
  App.room = App.cable.subscriptions.create("TelaoNotificationsChannel", {
    received: function(data) {
      carregaDados();
    }
  });

});
</script>